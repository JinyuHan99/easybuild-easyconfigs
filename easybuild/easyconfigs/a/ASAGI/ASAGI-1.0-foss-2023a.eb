# #
# This is a contribution from HPCNow! (http://hpcnow.com)
# Copyright::   HPCNow!
# Authors::     Jonney Huang <jonney.huang@hpcnow.com>
# License::     GPL-v3.0
# #

easyblock = 'CMakeMake'

name = 'ASAGI'
local_commit_id = 'f672507'
version = '1.0'

homepage = 'https://github.com/TUM-I5/ASAGI'
description = """ a pArallel Server for Adaptive GeoInformation.
"""

toolchain = {'name': 'foss', 'version': '2023a'}

sources = [{
    'git_config': {
        'url': 'https://github.com/TUM-I5/',
        'repo_name': 'ASAGI',
        'commit': local_commit_id,
        'recursive': True,
    },
    'filename': SOURCE_TAR_GZ,
}]
patches = [
    ('ASAGI-CMakeList.patch', 0),
    ('ASAGI-level.h.patch', 0),
]
checksums = [
    {'ASAGI-1.0.tar.gz': '703927701a04850a6da9754427dcf429e455ca825673587f5df389980d7452d7'},
    {'ASAGI-CMakeList.patch': 'b7b9135adb3e21045c50eeae5caa27bb73c1cb385981e4e7561d1a64158ccdef'},
    {'ASAGI-level.h.patch': '2dcad7665a3e541c338645f3dc8ca02fe8a3eff2719afc3eb1247bee7e11c61f'},
]

builddependencies = [
    ('CMake', '3.26.3'),
    ('OpenMPI', '4.1.5'),
    ('pkg-config', '0.29.2'),
]

dependencies = [
    ('netCDF', '4.9.2'),
    ('numactl', '2.0.16'),
]

preconfigopts = "mkdir build && cd build &&"

configopts = " -DSHARED_LIB=yes"
configopts += " -DCMAKE_BUILD_TYPE=Release"
configopts += " -DMPI_C_COMPILER=mpicc -DMPI_CXX_COMPILER=mpiCC -DMPI_Fortran_COMPILER=mpif90"

prebuildopts = 'cd build &&'
preinstallopts = 'cd build &&'
sanity_check_paths = {
    'files': ['lib/libasagi.so'],
    'dirs': [],
}

moduleclass = 'geo'
